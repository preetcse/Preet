{% extends "base.html" %}

{% block title %}Add Transaction - {{ customer.name }} - Amarjit Electrical Store{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('customers') }}">Customers</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('customer_detail', id=customer.id) }}">{{ customer.name }}</a></li>
        <li class="breadcrumb-item active">Add Transaction</li>
    </ol>
</nav>

<div class="row">
    <div class="col-md-8">
        <h1><i class="fas fa-plus text-primary"></i> Add Transaction</h1>
        <p class="text-muted">For customer: <strong>{{ customer.name }}</strong> ({{ customer.phone }})</p>
        
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-shopping-cart"></i> Transaction Details</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="transaction_type" class="form-label">Transaction Type *</label>
                            <select class="form-select" id="transaction_type" name="transaction_type" required>
                                <option value="purchase">Purchase (Customer bought items)</option>
                                <option value="return">Return (Customer returned items)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="amount" class="form-label">Amount (₹) *</label>
                            <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction_date" class="form-label">Transaction Date *</label>
                        <input type="date" class="form-control" id="transaction_date" name="transaction_date" 
                               value="{{ date.today() }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" 
                                  placeholder="Describe the items purchased/returned"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bill_image" class="form-label">Bill Image</label>
                        <input type="file" class="form-control" id="bill_image" name="bill_image" 
                               accept="image/*" onchange="previewImage(this)">
                        <div class="form-text">
                            {% if session.credentials %}
                                <i class="fas fa-check text-success"></i> Images will be uploaded to Google Drive
                            {% else %}
                                <i class="fas fa-exclamation-triangle text-warning"></i> 
                                <a href="{{ url_for('google_auth') }}">Connect Google Drive</a> to store images
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Image Preview -->
                    <div id="imagePreview" class="mb-3" style="display: none;">
                        <label class="form-label">Preview:</label>
                        <div>
                            <img id="preview" src="#" alt="Image preview" style="max-width: 300px; max-height: 200px;" class="img-thumbnail">
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Add Transaction
                        </button>
                        <a href="{{ url_for('customer_detail', id=customer.id) }}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-user"></i> Customer Info</h6>
            </div>
            <div class="card-body">
                <p><strong>Name:</strong> {{ customer.name }}</p>
                <p><strong>Phone:</strong> {{ customer.phone }}</p>
                <p><strong>Current Debt:</strong> 
                    <span class="debt-amount {% if customer.total_debt > 0 %}debt-positive{% else %}debt-zero{% endif %}">
                        ₹{{ "%.2f"|format(customer.total_debt) }}
                    </span>
                </p>
                {% if customer.address %}
                <p><strong>Address:</strong> {{ customer.address }}</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> Information</h6>
            </div>
            <div class="card-body">
                <h6>Transaction Types:</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-plus text-success"></i> <strong>Purchase:</strong> Customer bought items (increases debt)</li>
                    <li><i class="fas fa-minus text-danger"></i> <strong>Return:</strong> Customer returned items (decreases debt)</li>
                </ul>
                
                <hr>
                
                <h6>Tips:</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-camera text-info"></i> Take clear photos of bills</li>
                    <li><i class="fas fa-cloud text-info"></i> Images are stored in Google Drive</li>
                    <li><i class="fas fa-edit text-info"></i> Be detailed in descriptions</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function previewImage(input) {
    const preview = document.getElementById('preview');
    const previewDiv = document.getElementById('imagePreview');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            preview.src = e.target.result;
            previewDiv.style.display = 'block';
        }
        
        reader.readAsDataURL(input.files[0]);
    } else {
        previewDiv.style.display = 'none';
    }
}

// Auto-set today's date
document.getElementById('transaction_date').value = new Date().toISOString().split('T')[0];
</script>
{% endblock %}