<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amarjit Electrical Store Ledger</title>
    <!-- Content Security Policy (CSP) for Firebase and CDNs -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.tailwindcss.com;
        style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
        img-src 'self' data: https://firebasestorage.googleapis.com;
        connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com https://*.googleapis.com;
        font-src 'self' data:;
    ">
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom right, #eff6ff, #e0e7ff); /* Light blue to indigo gradient */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for longer content */
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .container {
            max-width: 960px; /* Max width for desktop */
            width: 100%;
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* Deeper shadow */
            overflow: hidden;
            margin: 0 1rem; /* Horizontal margin for smaller screens */
        }
        header {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            padding: 1.5rem;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }
        h1 {
            font-size: 2.25rem; /* text-3xl */
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        nav {
            background-color: #6366f1; /* Indigo-500 */
            padding: 0.75rem;
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        nav button {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            color: white;
            flex: 1; /* Make buttons take equal width */
            text-align: center;
            font-weight: 500;
        }
        nav button.active {
            background-color: #4338ca; /* Indigo-700 */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        nav button:not(.active):hover {
            background-color: #4f46e5; /* Indigo-600 */
        }
        main {
            padding: 1.5rem;
        }
        .card {
            background-color: #f9fafb; /* Gray-50 */
            border: 1px solid #e5e7eb; /* Gray-200 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            padding: 1rem;
            cursor: pointer;
            transition: box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }
        .balance-positive {
            color: #ef4444; /* Red-600 */
        }
        .balance-negative {
            color: #22c55e; /* Green-600 */
        }
        .form-input, .form-textarea, .form-select {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db; /* Gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            outline: none;
            transition: border-color 0.2s ease-in-out, ring-color 0.2s ease-in-out;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: #6366f1; /* Indigo-500 */
            ring: 2px;
            ring-color: #818cf8; /* Indigo-400 */
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #ffffff;
            color: #374151; /* Gray-700 */
            border: 1px solid #d1d5db; /* Gray-300 */
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }
        .btn-secondary:hover {
            background-color: #f3f4f6; /* Gray-50 */
        }
        .message-success {
            color: #10b981; /* Green-600 */
        }
        .message-error {
            color: #ef4444; /* Red-600 */
        }

        /* Modal styles */
        .modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999; /* Ensure it's on top */
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        .modal-buttons button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .modal-buttons .confirm-btn {
            background-color: #4f46e5;
            color: white;
        }
        .modal-buttons .confirm-btn:hover {
            background-color: #4338ca;
        }
        .modal-buttons .cancel-btn {
            background-color: #e5e7eb;
            color: #374151;
        }
        .modal-buttons .cancel-btn:hover {
            background-color: #d1d5db;
        }

        /* Responsive adjustments */
        @media (min-width: 640px) { /* sm breakpoint */
            header {
                padding: 1.5rem 2rem;
            }
            h1 {
                font-size: 2.5rem; /* text-4xl */
            }
            nav {
                justify-content: flex-start;
                gap: 1rem;
                padding: 0.75rem 2rem;
            }
            nav button {
                flex: none;
            }
            main {
                padding: 2rem;
            }
            .card {
                padding: 1.5rem;
            }
        }

        /* Styles for the new global message div */
        #app-message {
            position: fixed;
            top: 1rem; /* Adjust as needed */
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000; /* Above modals */
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            min-width: 200px;
            text-align: center;
            display: none; /* Hidden by default */
        }

        /* Styles for image modal */
        .image-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .image-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-modal-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
        }
        .image-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .image-modal-close:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body>
    <div class="container" id="app-container">
        <!-- Header Section -->
        <header>
            <h1 class="text-2xl sm:text-3xl font-bold flex items-center">
                <span class="mr-2">⚡</span> Amarjit Electrical Ledger
            </h1>
            <div class="text-sm opacity-80">
                Your User ID: <span class="font-mono text-xs sm:text-sm" id="user-id-display">Loading...</span>
            </div>
        </header>

        <!-- Navigation Section -->
        <nav id="main-nav">
            <button id="nav-customers" class="active">Customers</button>
            <button id="nav-add-customer">Add New Customer</button>
            <button id="nav-customer-detail" class="hidden">Customer Details</button>
            <button id="nav-edit-customer" class="hidden">Edit Customer</button>
        </nav>

        <!-- Main Content Area -->
        <main id="main-content">
            <!-- Content will be dynamically loaded here -->
            <div class="text-center py-8 text-gray-700 text-lg font-semibold">Loading application...</div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Global Firebase Variables & Initialization ---
        let db;
        let auth;
        let storage;
        let currentUserId = null;
        let currentAppId = null;
        let selectedCustomer = null; // Holds the currently selected customer object
        let globalMessageDiv = null; // Reference to the single message div
        let messageHideTimeout = null; // To manage the timeout for hiding the message

        // Fallback Firebase Configuration for local development - UPDATED TO NEW PROJECT
        const localFirebaseConfig = {
            apiKey: "AIzaSyDf51rBM6vt6T-pgIdjb_KZXiiU6LOOmng",
            authDomain: "preet-31f16.firebaseapp.com",
            projectId: "preet-31f16",
            storageBucket: "preet-31f16.firebasestorage.app",
            messagingSenderId: "321214867701",
            appId: "1:321214867701:web:1c757da6e43803b966bdbc",
            measurementId: "G-TCCCS38VVM"
        };

        // Function to display messages (replaces console.log/alert for user feedback)
        function showMessage(msg, type = 'success') {
            if (!globalMessageDiv) {
                console.error("globalMessageDiv not initialized!");
                return; // Cannot display message if element not ready
            }
            
            // Clear any existing hide timeout
            if (messageHideTimeout) {
                clearTimeout(messageHideTimeout);
            }

            globalMessageDiv.textContent = msg;
            // Clear previous classes and add new ones
            globalMessageDiv.className = ''; // Reset class list
            globalMessageDiv.classList.add('fixed', 'top-4', 'left-1/2', '-translate-x-1/2', 'z-50', 'p-3', 'rounded-lg', 'shadow-lg', 'font-semibold', 'text-center', 'text-sm');
            if (type === 'success') {
                globalMessageDiv.classList.add('bg-green-100', 'text-green-800');
            } else {
                globalMessageDiv.classList.add('bg-red-100', 'text-red-800');
            }
            globalMessageDiv.style.display = 'block'; // Show the message

            // Set a new hide timeout
            messageHideTimeout = setTimeout(() => {
                globalMessageDiv.style.display = 'none'; // Hide the message
            }, 5000); // Message disappears after 5 seconds
        }

        // Global Confirmation Modal Function
        async function showConfirmationModal(message) {
            return new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'modal'; // Use the CSS class defined in <style>
                modal.innerHTML = `
                    <div class="modal-content">
                        <p class="text-lg font-semibold mb-4">${message}</p>
                        <div class="modal-buttons">
                            <button id="confirmAction" class="confirm-btn">Confirm</button>
                            <button id="cancelAction" class="cancel-btn">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('confirmAction').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(true);
                };
                document.getElementById('cancelAction').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(false);
                };
            });
        }

        // Global Image Modal Function
        function showImageModal(imageUrl) {
            const imageModal = document.createElement('div');
            imageModal.className = 'image-modal';
            imageModal.innerHTML = `
                <div class="image-modal-content">
                    <img src="${imageUrl}" alt="Full screen bill image">
                    <button class="image-modal-close">✖</button>
                </div>
            `;
            document.body.appendChild(imageModal);

            imageModal.querySelector('.image-modal-close').onclick = () => {
                document.body.removeChild(imageModal);
            };
            // Close modal if clicked outside image
            imageModal.onclick = (e) => {
                if (e.target === imageModal) {
                    document.body.removeChild(imageModal);
                }
            };
        }

        // --- Page Rendering Functions ---

        // Render Customer List Page
        async function renderCustomerList() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Your Customers</h2>
                <div id="overall-balance" class="p-4 rounded-lg text-center font-bold text-xl mb-6 bg-gray-100 text-gray-700">
                    Loading overall balance...
                </div>
                <div class="mb-6">
                    <input type="text" id="search-input" placeholder="Search customers by name or phone..." class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div id="customer-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-center py-8 text-gray-600 col-span-full">Loading customers...</p>
                </div>
            `;

            // Hide detail/edit buttons in nav
            document.getElementById('nav-customer-detail').classList.add('hidden');
            document.getElementById('nav-edit-customer').classList.add('hidden');

            const searchInput = document.getElementById('search-input');
            let customersData = []; // Store raw customer data for filtering

            // Real-time listener for customers
            const customersCollectionRef = collection(db, `artifacts/${currentAppId}/users/${currentUserId}/customers`);
            onSnapshot(customersCollectionRef, (snapshot) => {
                let totalOverallBalance = 0;
                customersData = []; // Clear previous data
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const totalDebt = (data.transactions || [])
                        .filter(t => t.type === 'debt' && !t.isPaid)
                        .reduce((sum, t) => sum + t.amount, 0);
                    const totalReturnCredit = (data.transactions || [])
                        .filter(t => t.type === 'return')
                        .reduce((sum, t) => sum + t.amount, 0);
                    const outstandingBalance = totalDebt - totalReturnCredit;
                    totalOverallBalance += outstandingBalance;
                    customersData.push({ id: doc.id, ...data, outstandingBalance });
                });
                customersData.sort((a, b) => a.name.localeCompare(b.name)); // Sort by name

                document.getElementById('overall-balance').textContent = `Total Outstanding Across All Customers: ₹${totalOverallBalance.toFixed(2)}`;
                document.getElementById('overall-balance').className = `p-4 rounded-lg text-center font-bold text-xl mb-6 ${totalOverallBalance > 0 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;

                filterAndDisplayCustomers();
            }, (err) => {
                console.error("Error fetching customers:", err);
                showMessage(`Error loading customers: ${err.message}`, 'error');
                mainContent.querySelector('#customer-list-container').innerHTML = `<p class="text-center py-8 text-red-600 col-span-full">Error loading customers: ${err.message}</p>`;
            });

            searchInput.addEventListener('input', filterAndDisplayCustomers);

            function filterAndDisplayCustomers() {
                const term = searchInput.value.toLowerCase();
                const filtered = customersData.filter(customer =>
                    customer.name.toLowerCase().includes(term) ||
                    customer.phone.includes(term)
                );

                const customerListContainer = document.getElementById('customer-list-container');
                customerListContainer.innerHTML = ''; // Clear previous list

                if (filtered.length === 0) {
                    c